{% extends 'backend_brokers/base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="container py-4">
    <div class="mb-4">
        <h2 class="h3 fw-bold border-bottom pb-2">{% trans "Panel Statystyk" %}</h2>
    </div>

    {% if error_message %}
    <div class="alert alert-danger mb-4" role="alert">
        <strong>{% trans "Błąd:" %}</strong> {{ error_message }}
    </div>
    {% endif %}

    <div id="debugData" class="alert alert-warning d-none mb-4">
        <strong>{% trans "DEBUG:" %}</strong> {% trans "Miesiące i sumy są puste. Sprawdź konsolę i widok Pythona." %}
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h4 class="h5 mb-3">{% trans "Agregowane transakcje (PLN)" %}</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "Miesiąc" %}</th>
                            <th>{% trans "Suma (PLN)" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in transactions_agg %}
                        <tr>
                            <td>{{ item.month|date:"F Y" }}</td>
                            <td>{{ item.total|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2" class="text-center text-muted">
                                {% trans "Brak transakcji do wyświetlenia" %}
                            </td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="2">
                                <strong>{% blocktrans with total=total_sum %}Łączna suma: {{ total|floatformat:2 }} zł{% endblocktrans %}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if request.user.is_superuser %}
    <div class="card mb-4">
        <div class="card-body">
            <h4 class="h5 mb-3">{% trans "Zagregowany zysk (PLN)" %}</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "Miesiąc" %}</th>
                            <th>{% trans "Zysk (PLN)" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in profit_agg %}
                        <tr>
                            <td>{{ item.month|date:"F Y" }}</td>
                            <td>{{ item.profit|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2" class="text-center text-muted">
                                {% trans "Brak danych o zysku" %}
                            </td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="2">
                                <strong>{% blocktrans with total=total_profit %}Łączny zysk: {{ total|floatformat:2 }} zł{% endblocktrans %}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="h5 mb-0">{% trans "Suma transakcji" %}</h4>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleLineLabels" checked>
                            <label class="form-check-label" for="toggleLineLabels">{% trans "Etykiety danych" %}</label>
                        </div>
                    </div>

                    <div id="chartContainer" class="mb-3" style="height: 400px;">
                        <canvas id="areaChart"></canvas>
                    </div>
                    <div id="noDataMessage" class="alert alert-secondary text-center d-none">
                        {% trans "Brak wystarczających danych do wygenerowania wykresu transakcji." %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="h5 mb-0">{% trans "Udział miesięczny w sumie transakcji" %}</h4>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="togglePieLabels" checked>
                            <label class="form-check-label" for="togglePieLabels">{% trans "Etykiety danych" %}</label>
                        </div>
                    </div>

                    <div style="height: 400px;">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ months_json|json_script:"months-data" }}
{{ totals_json|json_script:"totals-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


<script>
const monthsRaw = JSON.parse(document.getElementById('months-data').textContent);
const totalsRaw = JSON.parse(document.getElementById('totals-data').textContent);

const filtered = monthsRaw.map((m, i) => ({
    month: m,
    total: parseFloat(totalsRaw[i])
})).filter(item => item.total > 0);

const months = filtered.map(item => item.month);
const totals = filtered.map(item => item.total);

const chartContainer = document.getElementById('chartContainer');
const noDataMessage = document.getElementById('noDataMessage');
const debugData = document.getElementById('debugData');

const numericTotals = totals.filter(n => typeof n === 'number' && !isNaN(n));
const maxTotal = numericTotals.length > 0 && Math.max(...numericTotals) > 0
    ? Math.max(...numericTotals) * 1.1
    : 100;

if (months.length === 0 || numericTotals.length === 0) {
    chartContainer.classList.add('d-none');
    noDataMessage.classList.remove('d-none');
    debugData.classList.remove('d-none');
    console.warn("Brak danych do wygenerowania wykresów.");
    console.log("months:", months);
    console.log("totals:", totals);
} else {
    chartContainer.classList.remove('d-none');
    noDataMessage.classList.add('d-none');
    debugData.classList.add('d-none');

    Chart.defaults.font.family = 'Inter, sans-serif';
    Chart.defaults.borderColor = '#dee2e6';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    let showLineLabels = true;
    let showPieLabels = true;

    const sumLine = totals.reduce((a, b) => a + b, 0);
    const sumPie  = sumLine;

    const areaCtx = document.getElementById('areaChart').getContext('2d');
    const areaChart = new Chart(areaCtx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Suma transakcji (PLN)',
                data: totals,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#0d6efd'
            }]
        },
        options: {
            scales: {
                x: { grid: { display: false } },
                y: {
                    beginAtZero: true,
                    max: maxTotal,
                    ticks: {
                        callback: val => val.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 }),
                        color: '#6c757d'
                    },
                    grid: { color: '#f8f9fa' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    padding: 12,
                    callbacks: {
                        title: items => items[0].label,
                        label: ctx => {
                            const totalSum = ctx.dataset.data.reduce((a,b)=>a+b,0);
                            const percent = totalSum>0 ? (ctx.parsed.y/totalSum*100).toFixed(1) : 0;
                            return ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} zł (${percent}%)`;
                        }
                    }
                },
                datalabels: {
                    display: ctx => showLineLabels,
                    align: 'top',
                    anchor: 'end',
                    offset: 4,
                    formatter: (value) => {
                        const percent = sumLine > 0 ? (value / sumLine * 100).toFixed(1) : '0.0';
                        return `${value.toFixed(2)} zł\n(${percent}%)`;
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: months,
        datasets: [{
        data: totals,
        backgroundColor: months.map((_, i) => `hsl(${i * 30}, 70%, 60%)`),
        borderWidth: 1
        }]
    },
    options: {
        layout: { padding: 8 },
        plugins: {
        legend: {
            position: 'bottom',
            labels: { color: '#212529' }
        },
        tooltip: {
            callbacks: {
            label: ctx => {
                const dataset = ctx.dataset.data;
                const total = dataset.reduce((a,b)=>a+b,0);
                const value = ctx.parsed;
                const percent = total>0 ? (value/total*100).toFixed(1) : 0;
                return `${ctx.label}: ${value.toFixed(2)} zł (${percent}%)`;
            }
            }
        },
        datalabels: {
            display: ctx => showPieLabels,
            anchor: 'end',
            align: 'end',
            offset: -8,
            color: '#212529',
            backgroundColor: 'rgba(255,255,255,0.85)',
            borderRadius: 4,
            padding: 4,
            textStrokeColor: 'white',
            textStrokeWidth: 2,
            formatter: (value) => {
            const percent = sumPie > 0 ? (value / sumPie * 100).toFixed(1) : '0.0';
            return `${value.toFixed(2)} zł (${percent}%)`;
            }
        }
        }
    },
    plugins: [ChartDataLabels]
    });

    const toggleLine = document.getElementById('toggleLineLabels');
    const togglePie  = document.getElementById('togglePieLabels');

    showLineLabels = toggleLine.checked;
    showPieLabels  = togglePie.checked;

    toggleLine.addEventListener('change', () => {
        showLineLabels = toggleLine.checked;
        areaChart.update();
    });

    togglePie.addEventListener('change', () => {
        showPieLabels = togglePie.checked;
        pieChart.update();
    });
}
</script>

{% if request.user.is_superuser %}
<div class="card mb-4">
    <div class="card-body text-center" >
        <a href="{% url 'generate_user_report' %}" class="btn btn btn-success">
            {% trans "Pobierz raport użytkowników (PDF)" %}
        </a>
    </div>
</div>
{% endif %}

{% endblock %}
